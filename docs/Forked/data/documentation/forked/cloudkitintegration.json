{"hierarchy":{"paths":[["doc:\/\/Forked\/documentation\/Forked"]]},"schemaVersion":{"minor":3,"patch":0,"major":0},"identifier":{"url":"doc:\/\/Forked\/documentation\/Forked\/CloudKitIntegration","interfaceLanguage":"swift"},"abstract":[{"text":"Learn how to use ForkedCloudKit to sync your data across devices.","type":"text"}],"kind":"article","seeAlsoSections":[{"generated":true,"anchor":"Articles","title":"Articles","identifiers":["doc:\/\/Forked\/documentation\/Forked\/GettingStarted","doc:\/\/Forked\/documentation\/Forked\/ForkedInnards"]}],"variants":[{"paths":["\/documentation\/forked\/cloudkitintegration"],"traits":[{"interfaceLanguage":"swift"}]}],"sections":[],"metadata":{"title":"CloudKit Integration Guide","roleHeading":"Article","role":"article","modules":[{"name":"Forked"}]},"primaryContentSections":[{"content":[{"text":"Overview","anchor":"Overview","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"type":"text","text":"ForkedCloudKit makes it easy to sync your Forked data between devices using Apple’s CloudKit framework. This guide will walk you through the basic setup and usage."}]},{"type":"heading","anchor":"Getting-Started","level":2,"text":"Getting Started"},{"inlineContent":[{"text":"First, make sure you have the ForkedCloudKit subpackage added to your project dependencies.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"Then import ForkedCloudKit in your source files:","type":"text"}]},{"syntax":"swift","code":["import Forked","import ForkedCloudKit"],"type":"codeListing"},{"type":"heading","level":2,"text":"Basic Setup","anchor":"Basic-Setup"},{"type":"paragraph","inlineContent":[{"text":"The main class you’ll work with is ","type":"text"},{"code":"CloudKitExchange","type":"codeVoice"},{"type":"text","text":". Here’s how to set it up:"}]},{"syntax":"swift","code":["\/\/ Create a ForkedResource for your data","let repo = try AtomicRepository(managedFileURL: fileURL)","let forkedResource = try ForkedResource(repository: repo)","","\/\/ Create CloudKitExchange instance","let cloudKitExchange = try CloudKitExchange(","    id: \"<Unique ID for the repo in CloudKit>\",","    forkedResource: forkedResource,","    unknownModelVersionHandler: { error in","        \/\/ Handle unknown model version by printing the error","        \/\/ In a real app, you might want to show a UI alert telling the user to update","        print(\"Error: \\(error)\")","    }",")"],"type":"codeListing"},{"inlineContent":[{"text":"The ","type":"text"},{"type":"codeVoice","code":"id"},{"type":"text","text":" parameter should be a unique string that identifies this resource in CloudKit."}],"type":"paragraph"},{"type":"heading","anchor":"How-It-Works","text":"How It Works","level":2},{"inlineContent":[{"type":"text","text":"CloudKitExchange automatically:"}],"type":"paragraph"},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Monitors changes to your ForkedResource’s main fork"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Uploads changes to iCloud when detected"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Downloads changes from other devices"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Before merging any changes, it checks the model version of the remote data and the local data. If the model version from iCloud is one that is unknown in the local app, it calls the "},{"type":"codeVoice","code":"unknownModelVersionHandler"},{"type":"text","text":" closure, and stops syncing. The user should update their app to the latest version."}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"If the model is known, it merges the remote changes into your local data on the main fork"}]}]}],"type":"orderedList"},{"type":"paragraph","inlineContent":[{"text":"All of this happens in the background without blocking your app’s UI.","type":"text"}]},{"anchor":"Model-Versioning","text":"Model Versioning","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"ForkedCloudKit requires your model to conform to ","type":"text"},{"type":"codeVoice","code":"VersionedModel"},{"text":" to ensure safe syncing across different app versions. This is crucial because:","type":"text"}]},{"type":"orderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"Different versions of your app may have different data models"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"When syncing, you need to ensure the app can understand the data it receives"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"Older versions of your app should not try to merge data from newer, unknown model versions","type":"text"}],"type":"paragraph"}]}]},{"type":"paragraph","inlineContent":[{"text":"Here’s how to make your model versioned:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["@ForkedModel(version: 1)","struct MyData {","    ...","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"When you update your model in a new app version, increment the version by 1."}]},{"inlineContent":[{"type":"text","text":"If CloudKitExchange encounters data with an unknown version (higher than the version in the code):"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"It calls your ","type":"text"},{"type":"codeVoice","code":"unknownModelVersionHandler"},{"type":"text","text":" closure"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Stops syncing to prevent data corruption","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"The user should be prompted to update their app"}]}]}],"type":"orderedList"},{"anchor":"Example-Implementation","type":"heading","text":"Example Implementation","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"Here’s a complete example showing how to integrate CloudKit sync into a SwiftUI app:"}]},{"code":["@Observable","@MainActor","class Store {","    private let repo: AtomicRepository<MyData>","    private let forkedResource: ForkedResource<AtomicRepository<MyData>>","    private var cloudKitExchange: CloudKitExchange<AtomicRepository<MyData>>!","","    \/\/\/ Set to true when the user needs to upgrade their model","    public var showUpgradeAlert = false","    ","    init() throws {","        \/\/ Setup local storage","        let fileURL = \/\/ ... your file URL","        repo = try AtomicRepository(managedFileURL: fileURL)","        forkedResource = try ForkedResource(repository: repo)","        ","        \/\/ Initialize CloudKit sync","        cloudKitExchange = try CloudKitExchange(","            id: \"<Unique ID for the repo in CloudKit>\",","            forkedResource: forkedResource,","            unknownModelVersionHandler: { [weak self]error in","                self?.showUpgradeAlert = true","            }","        )","    }","}"],"type":"codeListing","syntax":"swift"},{"text":"CloudKit Setup in Xcode","level":2,"type":"heading","anchor":"CloudKit-Setup-in-Xcode"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Before your app can use CloudKit:"}]},{"items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Enable iCloud in your Xcode target’s capabilities tab"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Choose or add a container ("},{"type":"emphasis","inlineContent":[{"type":"text","text":"eg"}]},{"type":"text","text":" “iCloud.com.mycompany.myapp”). The container ID should match the "},{"code":"id","type":"codeVoice"},{"type":"text","text":" parameter in your "},{"code":"CloudKitExchange","type":"codeVoice"},{"text":" initializer.","type":"text"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Also enable the background modes for remote notifications and background processing"}],"type":"paragraph"}]}],"type":"orderedList"},{"text":"Advanced Usage","type":"heading","anchor":"Advanced-Usage","level":2},{"type":"heading","text":"Custom Container","level":3,"anchor":"Custom-Container"},{"type":"paragraph","inlineContent":[{"type":"text","text":"By default, CloudKitExchange uses the default CloudKit container. You can specify a custom container:"}]},{"type":"codeListing","syntax":"swift","code":["let container = CKContainer(identifier: \"iCloud.com.mycompany.myapp-another-container\")","let cloudKitExchange = try CloudKitExchange(","    id: \"<Unique ID for the repo in CloudKit>\",","    forkedResource: forkedResource,","    cloudKitContainer: container,","    unknownModelVersionHandler: { error in","        print(\"Error: \\(error)\")","    }",")"]},{"anchor":"Monitoring-Sync-Updates","level":3,"text":"Monitoring Sync Updates","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"CloudKitExchange automatically handles sync in the background, but you can monitor when changes from CloudKit are merged into your main fork.","type":"text"}]},{"inlineContent":[{"type":"text","text":"To do this, add a "},{"code":"Task","type":"codeVoice"},{"text":" on launch that monitors the ","type":"text"},{"type":"codeVoice","code":"changeStream"},{"type":"text","text":" for changes from CloudKit:"}],"type":"paragraph"},{"code":["Task {","    for await change in forkedResource.changeStream ","        where change.fork == .main && change.mergingFork == .cloudKit {","        \/\/ Handle changes merged from CloudKit into main fork","    }","}"],"syntax":"swift","type":"codeListing"},{"text":"CloudKit Schema Setup","level":2,"anchor":"CloudKit-Schema-Setup","type":"heading"},{"inlineContent":[{"text":"Before your app can use CloudKit, you need to set up the schema. You could do this by running your app in development mode in Xcode, but if you do this, you are unlikely to trigger certain situations, such as when you have a very large file. For this reason, it is best to actively import the CloudKit schema used by Forked.","type":"text"}],"type":"paragraph"},{"type":"orderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"text":"Enable iCloud in your Xcode target’s capabilities tab","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Choose or add a container ("},{"type":"emphasis","inlineContent":[{"type":"text","text":"eg"}]},{"type":"text","text":" “iCloud.com.mycompany.myapp”)"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Import the CloudKit schema file (","type":"text"},{"code":"cloudkit-schema.ckdb","type":"codeVoice"},{"text":") into your development environment using the CloudKit Console (https:\/\/icloud.developer.apple.com)","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Deploy the schema to production before releasing your app"}]}]}]},{"inlineContent":[{"text":"The schema defines two Forked-related record types:","type":"text"}],"type":"paragraph"},{"syntax":null,"code":["RECORD TYPE ForkedAsset (","    \"___createTime\" TIMESTAMP,","    \"___createdBy\"  REFERENCE,","    \"___etag\"       STRING,","    \"___modTime\"    TIMESTAMP,","    \"___modifiedBy\" REFERENCE,","    \"___recordID\"   REFERENCE,","    asset           ASSET,","    asset_part1     ASSET,","    asset_part2     ASSET,","    asset_part3     ASSET,","    asset_part4     ASSET,","    asset_part5     ASSET,","    deleted         BOOLEAN QUERYABLE SORTABLE,","    numberOfParts   INT64 QUERYABLE SORTABLE,","    totalSize       INT64 QUERYABLE SORTABLE,","    GRANT WRITE TO \"_creator\",","    GRANT CREATE TO \"_icloud\",","    GRANT READ TO \"_world\"",");","","RECORD TYPE ForkedResource (","    \"___createTime\" TIMESTAMP,","    \"___createdBy\"  REFERENCE,","    \"___etag\"       STRING,","    \"___modTime\"    TIMESTAMP,","    \"___modifiedBy\" REFERENCE,","    \"___recordID\"   REFERENCE,","    largeData       ASSET,","    peerId          STRING QUERYABLE SEARCHABLE SORTABLE,","    resourceData    ENCRYPTED BYTES,","    GRANT WRITE TO \"_creator\",","    GRANT CREATE TO \"_icloud\",","    GRANT READ TO \"_world\"",");"],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Important"}]},{"type":"text","text":": You must deploy the schema to production before releasing your app. If you don’t, users won’t be able to sync their data."}]},{"level":2,"type":"heading","text":"Managing File Assets with CloudKitAssets","anchor":"Managing-File-Assets-with-CloudKitAssets"},{"inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"CloudKitAssets"},{"type":"text","text":" class provides a simple way to manage file assets with CloudKit synchronization. It automatically handles:"}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"text":"Storing files in CloudKit","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Syncing files across devices"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"Splitting large files into parts (up to 250MB total)","type":"text"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"Soft deletion of files"}]}]}],"type":"unorderedList"},{"level":3,"type":"heading","text":"Basic Usage","anchor":"Basic-Usage"},{"type":"codeListing","syntax":"swift","code":["\/\/ Initialize CloudKitAssets with a directory for local storage","let rootDirectory = FileManager.default.urls(for: .documentDirectory, in: .userDomainMask)[0]","    .appendingPathComponent(\"CloudKitAssets\")","let cloudKitAssets = try CloudKitAssets(","    rootDirectory: rootDirectory,","    zoneName: \"MyAssets\"",")","","\/\/ Add a file asset","let fileURL = \/\/ ... your file URL","try cloudKitAssets.addAsset(at: fileURL, named: \"myfile.pdf\")","","\/\/ Add a data asset","let data = \/\/ ... your data","try cloudKitAssets.addAsset(data: data, named: \"mydata.json\")","","\/\/ Delete an asset","try cloudKitAssets.deleteAsset(named: \"myfile.pdf\")","","\/\/ List all assets","let assets = try cloudKitAssets.listAssets()","","\/\/ Get data for an asset","let data = try cloudKitAssets.data(forAssetNamed: \"mydata.json\")"]},{"text":"Monitoring Changes","level":3,"type":"heading","anchor":"Monitoring-Changes"},{"type":"paragraph","inlineContent":[{"text":"You can monitor changes to assets using the ","type":"text"},{"type":"codeVoice","code":"changeStream"},{"type":"text","text":" property:"}]},{"syntax":"swift","code":["Task {","    for await change in cloudKitAssets.changeStream {","        if change.initiatedLocally {","            print(\"Local change: \\(change.fileName)\")","        } else {","            print(\"Remote change: \\(change.fileName)\")","        }","    }","}"],"type":"codeListing"},{"type":"heading","level":3,"text":"File Size Limits","anchor":"File-Size-Limits"},{"items":[{"content":[{"inlineContent":[{"text":"Individual files must be under 250MB","type":"text"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"type":"text","text":"Files over 50MB are automatically split into parts (up to 5 parts)"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"text":"The total size of all parts must not exceed 250MB","type":"text"}],"type":"paragraph"}]}],"type":"unorderedList"},{"level":2,"text":"Troubleshooting","type":"heading","anchor":"Troubleshooting"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Common issues and solutions:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"No Sync"}]},{"type":"text","text":": Ensure iCloud is enabled on the device, the user is signed in, and iCloud Drive enabled"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"text":"Data Not Appearing","type":"text"}],"type":"strong"},{"type":"text","text":": Check that your CloudKit container is properly configured."}]}]},{"content":[{"type":"paragraph","inlineContent":[{"inlineContent":[{"type":"text","text":"No Sync in Production Version"}],"type":"strong"},{"type":"text","text":": Make sure you push your CloudKit schema to production before launching your app. Use the CloudKit web portal (https:\/\/icloud.developer.apple.com) to do this"}]}]},{"content":[{"inlineContent":[{"type":"strong","inlineContent":[{"type":"text","text":"Conflicts"}]},{"text":": ForkedCloudKit automatically handles conflicts using your resource’s merge strategy","type":"text"}],"type":"paragraph"}]}]},{"type":"heading","level":2,"anchor":"Further-Reading","text":"Further Reading"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"https:\/\/developer.apple.com\/documentation\/cloudkit","isActive":true}]}]},{"content":[{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/drewmccormack\/Forked"}]}]},{"content":[{"inlineContent":[{"type":"text","text":"Sample App: "},{"isActive":true,"type":"reference","identifier":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud"}],"type":"paragraph"}]}]}],"kind":"content"}],"references":{"doc://Forked/documentation/Forked/GettingStarted":{"abstract":[{"text":"Learn how to use Forked to manage shared data in your Swift applications.","type":"text"}],"kind":"article","role":"article","title":"Getting Started with Forked","identifier":"doc:\/\/Forked\/documentation\/Forked\/GettingStarted","url":"\/documentation\/forked\/gettingstarted","type":"topic"},"https://github.com/drewmccormack/Forked":{"url":"https:\/\/github.com\/drewmccormack\/Forked","type":"link","title":"Forked Documentation","titleInlineContent":[{"type":"text","text":"Forked Documentation"}],"identifier":"https:\/\/github.com\/drewmccormack\/Forked"},"https://developer.apple.com/documentation/cloudkit":{"title":"CloudKit Documentation","identifier":"https:\/\/developer.apple.com\/documentation\/cloudkit","type":"link","titleInlineContent":[{"type":"text","text":"CloudKit Documentation"}],"url":"https:\/\/developer.apple.com\/documentation\/cloudkit"},"doc://Forked/documentation/Forked/ForkedInnards":{"abstract":[{"type":"text","text":"Forked is built around a simple yet powerful concept: data conflicts should be treated as a natural part of software systems rather than an exceptional state."}],"identifier":"doc:\/\/Forked\/documentation\/Forked\/ForkedInnards","url":"\/documentation\/forked\/forkedinnards","role":"article","title":"Forked Innards: Understanding the Architecture","type":"topic","kind":"article"},"doc://Forked/documentation/Forked":{"title":"Forked","url":"\/documentation\/forked","abstract":[{"text":"A framework for handling shared data with confidence in Swift.","type":"text"}],"kind":"symbol","role":"collection","type":"topic","identifier":"doc:\/\/Forked\/documentation\/Forked"},"https://github.com/drewmccormack/Forked/tree/main/Samples/Forking%20Simple%20iCloud":{"title":"Forking Simple iCloud","identifier":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud","type":"link","titleInlineContent":[{"type":"text","text":"Forking Simple iCloud"}],"url":"https:\/\/github.com\/drewmccormack\/Forked\/tree\/main\/Samples\/Forking%20Simple%20iCloud"}}}